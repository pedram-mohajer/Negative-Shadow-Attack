# 🕳️ Negative Shadow Attack: Adversarial Bright Patterns for Lane Detection Deception

This repository implements the **Negative Shadow (NS) attack**—a stealthy and practical adversarial technique that deceives state-of-the-art lane detection (LD) systems using bright, lane-like patterns. These patterns, generated by casting sunlight through occluders, exploit brightness-based vulnerabilities in LD pipelines, causing misdetection without altering road infrastructure.

---

## 🔧 Installation (Docker Recommended)

To ensure reproducibility and GPU support, we strongly recommend running in a Docker environment.

### 1. Install Docker & Compose

```bash
sudo apt install docker-compose
sudo service docker start
```

### 2. Enable NVIDIA Runtime

Update `/etc/docker/daemon.json`:

```json
{
    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    },
    "default-runtime": "nvidia"
}
```

Then restart Docker:

```bash
sudo systemctl restart docker
```

### 3. Build and Run the Container

```bash
docker compose build --build-arg UID="$(id -u)" dev
docker compose run --rm dev
```

---

## 🚀 Project Overview

This pipeline simulates and evaluates the Negative Shadow attack under two modes:

- **Random Mode**: generate `n` random shadows and test three LD models.
- **Search Mode**: apply a Genetic Algorithm to find adversarial NS parameters.

### Supported Lane Detectors:
- **TwinLiteNet** (lightweight, feature-based)
- **HybridNets** (multi-task perception network)
- **CLRerNet** (confidence-regularized)

---

## ▶️ Running the Pipeline

### Default Entry: `main.py`

```bash
python main.py
```

By default, `main.py` runs search-based optimization. To run random sampling instead:

```python
if __name__ == "__main__":
    main(n_samples=10000, search_based=False)
```

### What It Does
- Generates NS images in BEV (`NS_Images_BEV/`)
- Warps them to driver-view (`NS_Images_Driver/`)
- Evaluates lane overlap using all three detectors
- Stores metadata in `shadow_lengths.csv`
- Outputs visual results and detection flags to `results/`

---

## 📁 Directory Structure

```
NS_Images_BEV/         # Bright regions in top-down BEV
NS_Images_Driver/      # Warped driver-view images
results/
├── TwinLiteNet/
├── HybridNets/
├── CLRerNet/
└── result.csv          # Final CSV summary with detection flags

pretrained/
├── twinlite/best.pth
├── hybrid/weights/
└── clrernet_culane_dla34_ema.pth
```

---

## 🧬 Genetic Optimization (Search Mode)

`optimizer.py` runs a Genetic Algorithm to evolve high-impact shadow parameters.

Fitness is based on:
- **Detector Fooling**: overlap between NS region and predicted lanes
- **Geometric Realism**: shadow length, width, distance to lane, and angle

Top candidates are retained and mutated over generations to find stealthy yet effective shadows.

---

## 📊 Analysis

To interpret detection patterns:

```python
from range_finder import analyse
analyse("NS_Images_BEV/shadow_lengths.csv", results_bool)
```

This prints:
- Parameter ranges associated with misclassified cases
- Interpretable decision tree showing detection boundaries (requires `scikit-learn`)

---

## 🛡️ Disclaimer

This research is intended solely for academic and ethical security analysis. All experiments were run in simulation or controlled conditions. The NS attack demonstrates vulnerabilities in lane detection pipelines and emphasizes the need for robust defenses in AV perception systems.

---

## 📄 Citation

If you use this codebase or results, please cite the paper:

```
@inproceedings{negative_shadow2025,
  title     = {Living in the Shadows: Practical Attack on Autonomous Vehicle Lane Detection},
  booktitle = {USENIX Security '25},
  year      = {2025}
}
```
